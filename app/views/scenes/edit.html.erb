<%current_event = Event.for_scene(@scene).at(@event_index).first%>
<%bg_file =  @scene.image_at(@event_index).get_file%>
<table class="scene-editor">
	<tr>
		<td>
			
			  <p><b>Scene <%=@scene.order_index%>:</b> <%=@scene.get_description%></p>
			<table class="table table-condensed">
			  <tr><td>
			  	 <h2>Script</h2>
			  	 <div class="script-holder">
			  	 <table class="script table-bordered table-hover table-condensed">
			  	 	<tbody>
			  	 	<%if Event.for_scene(@scene).empty?%>
			  	 	  <tr><td>Nothing in the script yet.</td></tr>
			  	 	<%end%>
			  	 	<%Event.for_scene(@scene).ordered.each do |event|%>
			  	 	  <tr data-order-id="<%=event.order_index%>" data-id="<%=event.id%>" id="row<%=event.id%>" class="<%="selected" if @event_index==event.order_index%>">
			  	 	  	<td><%=event.order_index%></td>
			  	 	  	<td>
			  	 	  		<%if @event_index!=event.order_index%>
			  	 	  		  <div class="jump-to tippable" title="Jump Here" data-url="<%=edit_project_scene_url(@project, @scene, :event_index=>event.order_index)%>">
			  	 	  		<%end%>

			  	 	  		<%unless event.is_a?(NarrationEvent)%>
			  	 	  		  <span class='muted'><%=event.to_sentence%></span><br/>
			  	 	  		<%end%>
			  	 	  		<small class="detail"><%=event.detail%></small>

			  	 	  		<%if @event_index!=event.order_index%></div><%end%>
			  	 	  		
			  	 	  		<div class="more hide"><hr>
			  	 	  		<input type="hidden" class="event_text" value="<%=event.text%>">
			  	 	  		<a class="btn btn-small <%=event_to_js(event)%>" href="#" data-name="<%=event.get_character_name%>" data-type="<%=event.type%>" data-character-id="<%=event.character.try(:id)%>"><i class="icon-pencil"></i><%=event_to_command(event)%></a><br/>
			  	 	  		  <%if event.order_index != 1%>
			  	 	  		    <a class="btn btn-small" href="<%=moveup_event_path(event)%>"><i class="icon-arrow-up"></i> Move Up</a>
			  	 	  		  <%end%><%if event.order_index != @event_count%>
			  	 	  		  <a class="btn btn-small" href="<%=movedown_event_path(event)%>"><i class="icon-arrow-down"></i> Move Down</a>
			  	 	  		  <%end%>
			  	 	  		  <a class="btn btn-small confirmable" href="<%=delete_event_path(event)%>"><i class="icon-remove"></i> Remove</a>
			  	 	  		</div>
			  	 	  	</td>
			  	 	  	<td width="28">
			  	 	  		<a class="btn btn-mini" href="#" id='dropdown' title="Edit or Delete"><i class="icon-pencil"></i></a>
			  	 	  	</td>
			  	 	  </tr>
			  	 	<%end%>
			  	    </tbody>
			  	 </table></div> 
			  	 <h3>Add to the Script!</h3>
			  	 <%@project.characters.each do |character|%>
			  	   <%if @scene.has_character?(character, @event_index)%>
			  	      <table class="action-items table-bordered">
				  	 	<tr><td rowspan=3><%=image_tag "spacer.gif", :style=>"background-color:lightgray"%></td>
				  	 	<td><a href="#" class="edit-speak" data-type="CharacterSpeaksEvent" data-character-id="<%=character.id%>" data-name="<%=character.name%>"><%=character.name%> speaks</a></td></tr>
				  	 	<tr><td><a href="#" class="edit-pose" data-character-id="<%=character.id%>"><%=character.name%> changes pose</a></td></tr>
				  	 	<tr><td>
				  	 		<%=form_tag update_event_project_scene_path(@project, @scene)%>
				  	 		  <input type="hidden" name="event[type]" value="CharacterVanishEvent">
				  	 		  <input type="hidden" name="event[character_id]" value="<%=character.id%>">
				  	 		  <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
				  	 		  <a href="#" class="submitable"><%=character.name%> vanishes</a>
				  	 	    </form>
				  	 	</td></tr>
			  	      </table>
			  	   <%else%>
			  	      <%if character.is_narrator?%>
			  	        <table class="action-items">
					  	 	<tr><td rowspan=3 class="icon"><span class="btn"><%=image_tag "spacer.gif", :style=>"background-color:lightgray; height:56px"%></span></td>
					  	 	<td class="btn btn-small"><a href="#" class="edit-speak" data-type="NarrationEvent" data-character-id="<%=character.id%>" data-name="">Narration</td></tr>
					  	 	<tr><td class="btn btn-small"><a href="#" class="edit-speak" data-type="CharacterThinksEvent" data-character-id="<%=character.id%>" data-name="<%=character.name%>"><%=character.name%> thinks</td></tr>
					  	 	<tr><td class="btn btn-small"><a href="#" class="edit-speak" data-type="CharacterSpeaksEvent" data-character-id="<%=character.id%>" data-name="<%=character.name%>"><%=character.name%> speaks</a></td></tr>
			  	        </table>
			  	      <%else%>
			  	        <table class="action-items">
					  	 	<tr><td rowspan=1 class="icon"><span class="btn"><%=image_tag "spacer.gif", :style=>"background-color:lightgray; height:56px"%></span></td>
					  	 	<td class="btn btn-small"><a href="#" class="edit-pose" data-character-id="<%=character.id%>"><%=character.name%> appears</a></td></tr>
					  	 </table>  
			  	      <%end%>
			  	   <%end%>
			  	 <%end%>
			  	 <table class="action-items">
			  	 	<tr><td rowspan=4 class="icon"><div class="btn">
			  	 		<%=image_tag bg_file, :class=>"bg", :style=>"height:56px"%> </div></td>
			  	 	<td class="btn btn-small"><a href="#" class="edit-bg-image">Background changes</a></td></tr>
			  	 	<tr><td class="btn btn-small"><a href="#" class="edit-music">Music changes</a></td></tr>
			  	 	<tr><td class="btn btn-small"><%=link_to "Preview!", play_scene_path(@project, @project.basename, @scene)%></td></tr>
			  	 	
			  	 </table>
			  </td></tr>
			</table>
			<%=form_for [@project, @scene] do |f|%>
			  <%=f.hidden_field :custom_description, :value=>@scene.get_description%>
			  <a class="btn btn-small change-scene-name">Change Scene Name</a>
		    <%end%>
		    <%= form_for([@project, @scene], :method => :delete) do |f|%>   
			  <a class="btn btn-small delete-scene">Delete Scene</a>
			<%end%>
		</td>
		<td>
		  <div class="mini-editor">

		  	<!-- Stage Viewer -->
		    <div class="mini-viewer">
		      
			  <%=image_tag bg_file, :class=>"bg"%>
			  <%if current_event%>
			  <%current_event.characters_present.each do |char_present|%>
			      <%=image_tag char_present[1], :class=>"characters"%>
			  <%end%>
			  <%end%>
			  
			    <!-- edit text -->
			    <div class="glassbox" style="<%="display:none" if !current_event.try(:glassbox?)%>">
			    	<%=image_tag "glassbox#{'_n' if current_event && current_event.is_a?(NarrationEvent)}.png", :class=>"glass"%>
			    	<div class="speaker"><%=current_event.try(:get_character_name)%></div>
			    	<div class="textarea"><%=current_event.try(:get_text)%></div>

			    	  <%=form_tag update_event_project_scene_path(@project, @scene)%>
			    	  <textarea name="event[text]" value="" class="hide"></textarea>
			    	  <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
			    	  <input type="hidden" name="event[type]" class="event_type" value="">
			    	  <input type="hidden" name="event_id" class="event_id" value="">
			    	  <input type="hidden" name="event[character_id]" class="character_id" value="">
			    	  <input type="hidden" name="more_text" class="more_text" value="">
			    	  <input type="hidden" name="more_text_type" class="more_text_type" value="">
			    	  <a class="btn btn-mini add-more-text controls hide" href="#"><i class="icon-arrow-down"></i> Add More Text</a>
			    	  <a class="btn btn-mini submitable controls hide" href="#"><i class="icon-check"></i> Finished</a>
			    	  </form>
			    	
			    </div>
			  

		    </div>
		    <div class="overlay-topper hide"><span></span><a class="btn btn-small" href="#"><i class="icon-remove"></i> Close</a></div>

		    <!-- BG Images -->
		    <div class="overlay bg-image" style="display:none">
		    	<ul class="thumbnails">
		      <%BackgroundImageEvent.file_list.each do |option|%>
		        <li class="span2">
		        <%=form_tag update_event_project_scene_path(@project, @scene)%>
		          <input type="hidden" name="event[type]" value="BackgroundImageEvent">
		          <input type="hidden" name="event[filename]" value="<%=option.url%>">
		          <input type="hidden" name="event_id" class="event_id" value="">
		          <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
		          <a class="submitable thumbnail">
		          	<%= image_tag option.url%><p><%=option.title%></p>
		          </a>
		          
		        </form>
		        </li>
		      <%end%>
		      </ul>
		    </div>

		    <!-- Music -->
		    <div class="overlay music" style="display:none">
		    <ul class="graphic">
		    	<%=form_tag update_event_project_scene_path(@project, @scene)%>
		          <input type="hidden" name="event[type]" value="BackgroundMusicEvent">
		          <input type="hidden" name="event[filename]" value="">
		          <input type="hidden" name="event_id" class="event_id" value="">
		          <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
		          <li class="">
		          	<a class="silence" href="#">(Silence)</a><button class="submitable btn btn-small" href="#">Choose</button>
		          </li>
		        </form>
		      <%BackgroundMusicEvent.file_list.each do |option|%>
		    
		        <%=form_tag update_event_project_scene_path(@project, @scene)%>
		          <input type="hidden" name="event[type]" value="BackgroundMusicEvent">
		          <input type="hidden" name="event[filename]" value="<%=option.url%>">
		          <input type="hidden" name="event_id" class="event_id" value="">
		          <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
		          <li class="">
		          	<a class="" href="<%=option.url%>"><%=option.title%></a><button class="submitable btn btn-small" href="#">Choose</button>
		          </li>
		        </form>
		        
		      <%end%>
		      </ul>
		    </div>

		    <!-- Poses -->
		    <%@project.characters.each do |character|%>
		    <%next if character.is_narrator?%>
		      <div class="overlay poses-for-<%=character.id%>" style="display:none">
		      	<ul class="thumbnails">
			    <%character.type.constantize.pose_list.each do |option|%>
			      <%=form_tag update_event_project_scene_path(@project, @scene)%>
			        <li class="span2">
			        <input type="hidden" name="event[type]" value="CharacterPoseEvent">
		            <input type="hidden" name="event[filename]" value="<%=option.url%>">
		            <input type="hidden" name="event[character_id]" value="<%=character.id%>">
		            <input type="hidden" name="event[order_index]" class="event_order" value="<%=@event_index%>">
		            <input type="hidden" name="event_id" class="event_id" value="">
			  	     <a class="submitable thumbnail">
			  	    <%=image_tag(option.thumbnail)%><p><%=option.title%></p>
			  	    </a>
			  	  </form>
			  	  </li>
			  	<%end%>
			    </ul>
		      </div>
		    <%end%>
		  </div>
		</td>
	</tr>
</table>
 <div id="sm2-container">
  <!-- SM2 flash goes here -->

 </div>

